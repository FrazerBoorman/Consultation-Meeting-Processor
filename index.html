<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consultation Meeting Processor</title>
  <meta name="color-scheme" content="light dark" />
  <!-- Google OAuth client ID (same as other tools) -->
  <meta name="google-oauth-client-id"
        content="105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com" />

  <!-- SheetJS for Excel reading/writing (Updated version 0.20.3) -->
  <script type="text/javascript" src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root {
      --bg:#0f172a; --card:#020617; --panel:#020617; --border:#1e293b;
      --text:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --accent-soft:rgba(56,189,248,0.12);
      --danger:#ef4444;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg:#f8fafc; --card:#ffffff; --panel:#ffffff; --border:#e5e7eb;
        --text:#020617; --muted:#475569; --accent:#0ea5e9; --accent-soft:rgba(14,165,233,0.10);
        --danger:#b91c1c;
      }
    }
    * { box-sizing:border-box; }
    html, body { height:100%; }
    body {
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(900px 600px at 5% 0%, rgba(56,189,248,0.10), transparent 55%),
        radial-gradient(800px 600px at 95% 0%, rgba(129,140,248,0.12), transparent 50%),
        var(--bg);
      color:var(--text);
    }
    .wrap {
      max-width: 1200px;
      margin:0 auto;
      padding:18px;
    }
    .card {
      background:var(--card);
      border-radius:20px;
      border:1px solid var(--border);
      padding:18px 18px 22px;
      box-shadow:0 18px 40px rgba(15,23,42,0.45);
      margin-bottom:16px;
    }
    h1 {
      margin:0 0 4px;
      font-size:26px;
      letter-spacing:.02em;
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }
    .version {
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
    }
    .muted { color:var(--muted); font-size:14px; }
    .pill {
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      text-decoration:none;
      cursor:pointer;
    }
    .pill:hover {
      border-color:var(--accent);
      color:var(--accent);
      background:var(--accent-soft);
    }
    .section {
      margin-top:14px;
      padding:12px;
      border-radius:12px;
      background:rgba(15,23,42,0.65);
      border:1px dashed var(--border);
    }
    @media (prefers-color-scheme: light) {
      .section { background:#f9fafb; }
    }
    .section-title {
      font-size:13px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-bottom:6px;
    }
    label {
      font-size:13px;
      font-weight:600;
      margin-bottom:4px;
      display:block;
    }
    input, select, textarea {
      width:100%;
      font-size:14px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
    }
    textarea { resize:vertical; min-height:70px; }
    input::placeholder, textarea::placeholder { color:var(--muted); }
    .small-note { font-size:11px;color:var(--muted);margin-top:3px; }

    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:10px;
    }

    .btn-row { display:flex;flex-wrap:wrap;gap:8px;margin-top:8px; }
    button {
      border-radius:999px;
      border:1px solid var(--border);
      padding:8px 13px;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:var(--panel);
      color:var(--text);
      cursor:pointer;
      transition:transform .06s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }
    button.primary {
      border-color:var(--accent);
      background:linear-gradient(180deg,var(--accent-soft),transparent);
    }
    button:hover {
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(15,23,42,0.5);
    }

    #status, #aiStatus {
      font-size:12px;color:var(--muted);margin-top:4px;
    }
    .danger { color:var(--danger); }

    details.transcript summary {
      cursor:pointer;
      font-size:13px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .transcript-body {
      max-height:260px;
      overflow:auto;
      font-size:13px;
      line-height:1.5;
      border-radius:10px;
      border:1px solid var(--border);
      padding:8px;
      background:var(--panel);
      white-space:pre-wrap;
    }

    .summary-box {
      padding:8px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--panel);
      font-size:13px;
      line-height:1.5;
      max-height:260px;
      overflow:auto;
    }
    .summary-box h2 {
      font-size:13px;
      margin:0 0 4px;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--muted);
    }
    ul { margin:4px 0 6px 18px;padding:0;font-size:13px; }
    li { margin-bottom:2px; }

    table {
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th, td {
      border:1px solid var(--border);
      padding:4px 6px;
      vertical-align:top;
    }
    th {
      background:rgba(15,23,42,0.6);
      font-weight:600;
    }
    @media (prefers-color-scheme: light) {
      th { background:#e5e7eb; }
    }

    #productsTableWrapper, #proposalPreview {
      max-height:280px;
      overflow:auto;
      border-radius:10px;
      border:1px solid var(--border);
      padding:8px;
      background:var(--panel);
      font-size:13px;
      white-space:pre-wrap;
    }

    details.debug {
      margin-top:10px;
      border-radius:12px;
      border:1px dashed var(--border);
      padding:8px 10px;
      background:rgba(15,23,42,0.4);
      font-size:11px;
    }
    @media (prefers-color-scheme: light) {
      details.debug { background:#f3f4f6; }
    }
    details.debug summary {
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
    }
    details.debug pre {
      white-space:pre-wrap;
      font-size:11px;
      margin-top:4px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;">
        <div>
          <h1>
            Consultation Meeting Processor
            <span class="version">v0.1.1</span>
          </h1>
          <div class="muted">
            Pick a consultation event, upload the audio, get a transcript, structured summary,
            suggested kit from your spreadsheet template, and a proposal draft.
          </div>
        </div>
        <a href="https://frazerboorman.github.io/" class="pill">Frazer · AVD TOOLS</a>
      </div>

      <!-- STEP 1 – Calendar event -->
      <div class="section">
        <div class="section-title">Step 1 – Select consultation from Google Calendar</div>
        <div class="grid">
          <div>
            <label for="calendarId">Calendar ID</label>
            <input id="calendarId"
              value="bb14db72acb2ffd4230316960d02103fa66e54901522ff7b8113eec682f6d42e@group.calendar.google.com" />
            <div class="small-note">
              Same calendar you use in the other tools.
            </div>
          </div>
          <div>
            <label for="eventSelect">Recent events (last 14 days + today)</label>
            <select id="eventSelect">
              <option value="">Sign in to load events…</option>
            </select>
            <div id="status">Status: Waiting for sign-in…</div>
            <div id="aiStatus"></div>
          </div>
          <div style="align-self:end;">
            <button id="signinBtn" class="primary" type="button">Sign into Google</button>
            <div class="small-note">
              Same OAuth flow as the other tools.
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 2 – Audio upload + processing -->
      <div class="section">
        <div class="section-title">Step 2 – Upload consultation audio &amp; process</div>
        <div class="grid">
          <div>
            <label for="audioFile">Consultation audio / text file</label>
            <!-- now also accepts plain text files -->
            <input id="audioFile" type="file" accept="audio/*,text/plain" />
            <div class="small-note">
              Export from DJI Mic / Voice Memos first, or upload a .txt transcript. File never leaves your browser except to OpenAI’s API.
            </div>
          </div>
        </div>

        <div class="btn-row">
          <button id="processBtn" class="primary" type="button">Process meeting (transcribe + summarise)</button>
        </div>
        <div class="small-note">
          Uses your OpenAI key from <code>localStorage['avd_job_report_openai_key']</code>.
        </div>

        <div style="margin-top:10px;" class="grid">
          <div>
            <details class="transcript" id="transcriptDetails">
              <summary>Show full transcript</summary>
              <div class="transcript-body" id="transcriptBox">No transcript yet.</div>
            </details>
          </div>
          <div>
            <div class="summary-box">
              <h2>Consultation summary</h2>
              <div id="summaryBox">No summary yet.</div>
            </div>
          </div>
        </div>

        <div class="grid" style="margin-top:10px;">
          <div class="summary-box">
            <h2>Key issues</h2>
            <div id="issuesBox">–</div>
          </div>
          <div class="summary-box">
            <h2>Current equipment</h2>
            <div id="equipmentBox">–</div>
          </div>
        </div>

        <div class="summary-box" style="margin-top:10px;">
          <h2>Agreed / preferred solution</h2>
          <div id="solutionBox">–</div>
        </div>

        <details class="debug" style="margin-top:8px;">
          <summary>Debug view (structured AI JSON from transcript)</summary>
          <pre id="debugJson"></pre>
        </details>
      </div>

      <!-- STEP 3 – Spreadsheet template / product suggestions -->
      <div class="section">
        <div class="section-title">Step 3 – Suggest products from template spreadsheet</div>
        <div class="grid">
          <div>
            <label for="templateFile">Upload template spreadsheet (with “Products” sheet)</label>
            <input id="templateFile" type="file" accept=".xlsx,.xlsm,.xls" />
            <div class="small-note">
              This should be your master template. The tool reads the <strong>Products</strong> sheet,
              then writes selected rows into a new <strong>AutoSelected</strong> sheet rather than touching your formulas.
            </div>
          </div>
        </div>

        <div class="btn-row">
          <button id="generateProductsBtn" type="button">Generate product checklist (from summary + Products sheet)</button>
          <button id="downloadFilledTemplateBtn" type="button">Download workbook with AutoSelected</button>
        </div>

        <div class="small-note">
          Review the suggested products before you commit. Quantities &amp; notes come from the transcript where possible.
        </div>

        <div style="margin-top:10px;">
          <label>Suggested products (preview)</label>
          <div id="productsTableWrapper">No products suggested yet.</div>
        </div>
      </div>

      <!-- STEP 4 – Proposal generator -->
      <div class="section">
        <div class="section-title">Step 4 – Proposal generator (from priced spreadsheet)</div>
        <div class="grid">
          <div>
            <label for="pricedFile">Upload edited/priced spreadsheet</label>
            <input id="pricedFile" type="file" accept=".xlsx,.xlsm,.xls" />
            <div class="small-note">
              Use the template you’ve filled with prices, labour, totals etc.
              The tool will read the <strong>Clean</strong> sheet if present, otherwise the first sheet.
            </div>
          </div>
        </div>

        <div class="btn-row">
          <button id="generateProposalBtn" type="button" class="primary">Generate proposal / quote</button>
          <button id="downloadProposalDocBtn" type="button">Download proposal as Word (.doc)</button>
        </div>

        <div style="margin-top:10px;">
          <label>Proposal preview</label>
          <div id="proposalPreview">No proposal generated yet.</div>
        </div>
      </div>

    </div>

    <!-- Global debug panel -->
    <details class="debug">
      <summary>Debug panel</summary>
      <pre id="debugLog">(empty)</pre>
    </details>
  </div>

  <script>
    // =========================
    // CONFIG / SHARED CONSTANTS
    // =========================
    const CLIENT_ID = "105230737516-l8tlnck4idde83pjetrotobpt8borvts.apps.googleusercontent.com";
    const SCOPES   = "https://www.googleapis.com/auth/calendar.readonly";
    const OPENAI_KEY_STORAGE = "avd_job_report_openai_key";
    const TEXT_MODEL = "gpt-4.1-mini";  // same family as other tools
    const AUDIO_MODEL = "whisper-1";

    let tokenClient = null;
    let accessToken = null;
    let currentEvents = [];
    let lastTranscript = "";
    let lastStructuredSummary = null;
    let lastProductSelection = null;
    let lastProposalText = "";

    // ============== 
    // DEBUG LOGGER
    // ==============
    function logDebug(msg) {
      try {
        const el = document.getElementById("debugLog");
        if (!el) return;
        const ts = new Date().toISOString().replace("T"," ").slice(0,19);
        el.textContent += "[" + ts + "] " + msg + "\n";
        el.scrollTop = el.scrollHeight;
      } catch (e) {
        if (console && console.warn) console.warn("debugLog error", e);
      }
    }

    // ==============
    // STATUS HELPERS
    // ==============
    function setStatus(msg, isError) {
      const el = document.getElementById("status");
      if (!el) return;
      el.textContent = "Status: " + msg;
      el.className = isError ? "danger" : "";
      logDebug("STATUS: " + msg);
    }

    function setAiStatus(msg, isError) {
      const el = document.getElementById("aiStatus");
      if (!el) return;
      el.textContent = msg || "";
      el.className = isError ? "danger" : "";
      if (msg) logDebug("AI: " + msg);
    }
  </script>
</body>
</html>
